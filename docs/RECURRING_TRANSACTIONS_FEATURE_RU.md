# Функция повторяющихся платежей (Recurring Transactions)

**Версия:** 1.0.0  
**Дата:** 2025-01-27  
**Статус:** ✅ Реализовано

## Назначение

Функция повторяющихся платежей позволяет пользователям создавать автоматические транзакции, которые будут повторяться по заданному расписанию (ежедневно, еженедельно, ежемесячно, ежегодно). Это особенно полезно для подписок, аренды, зарплаты и других регулярных платежей.

## Основные возможности

### 1. Создание повторяющихся транзакций

- При добавлении транзакции расхода на этапе подтверждения пользователь может выбрать тип расписания:
  - **Standard** — обычная одноразовая транзакция
  - **Scheduled** — повторяющаяся транзакция
- При выборе "Scheduled" открывается модальное окно для настройки:
  - Название транзакции
  - Тип повторения (подписка, аренда, зарплата, счет, другое)
  - Частота (ежедневно, еженедельно, ежемесячно, ежегодно)
  - Дата начала
  - Дата окончания (опционально)
  - Примечание (опционально)

### 2. Отображение предстоящих транзакций

- За 3 дня до запланированного платежа в списке транзакций появляется полупрозрачная транзакция
- Показывается:
  - Название транзакции
  - Дата запланированного платежа
  - Количество дней до платежа ("Сегодня", "Завтра", "X дней до")
  - Сумма транзакции
  - Категория (если указана)

### 3. Автоматическое создание транзакций

- При запуске приложения и ежедневно система проверяет активные повторяющиеся транзакции
- Если дата платежа наступила (или прошла), автоматически создается обычная транзакция
- После создания транзакции рассчитывается следующая дата платежа
- Если достигнута дата окончания, повторяющаяся транзакция помечается как завершенная

## Технические детали

### Модель данных

#### RecurringTransaction

```typescript
interface RecurringTransaction {
  id: string;
  name: string; // Название, указанное пользователем
  type: TransactionType; // 'expense' | 'income' | 'saved' | 'credit'
  recurringType: RecurringTransactionType; // 'subscription' | 'rent' | 'salary' | 'bill' | 'other'
  amount: number;
  category?: string;
  frequency: RecurringFrequency; // 'daily' | 'weekly' | 'monthly' | 'yearly'
  startDate: string; // ISO string
  nextDueDate: string; // ISO string - следующая дата платежа
  endDate?: string; // ISO string - опциональная дата окончания
  creditProductId?: string;
  paidByCreditProductId?: string;
  goalId?: string;
  status: RecurringTransactionStatus; // 'active' | 'paused' | 'completed'
  createdAt: string; // ISO string
  updatedAt: string; // ISO string
  note?: string;
}
```

#### UpcomingTransaction

```typescript
interface UpcomingTransaction {
  id: string; // Генерируется для отображения
  recurringTransactionId: string; // Ссылка на повторяющуюся транзакцию
  name: string;
  type: TransactionType;
  amount: number;
  category?: string;
  scheduledDate: string; // ISO string - когда произойдет транзакция
  daysUntil: number; // Количество дней до транзакции
  creditProductId?: string;
  paidByCreditProductId?: string;
  goalId?: string;
}
```

### Компоненты

#### RecurringTransactionsProvider

- Управляет состоянием всех повторяющихся транзакций
- Обеспечивает персистентность данных через `AsyncStorage`
- Вычисляет предстоящие транзакции (в пределах 3 дней)
- Автоматически обрабатывает повторяющиеся транзакции при запуске приложения и ежедневно
- Предоставляет функции:
  - `createRecurringTransaction` — создание новой повторяющейся транзакции
  - `updateRecurringTransaction` — обновление существующей
  - `deleteRecurringTransaction` — удаление
  - `pauseRecurringTransaction` — приостановка
  - `resumeRecurringTransaction` — возобновление
  - `processRecurringTransactions` — обработка и создание транзакций по расписанию

#### RecurringTransactionModal

- Модальное окно для настройки повторяющейся транзакции
- Поля:
  - Название (обязательное)
  - Тип повторения (выбор из предустановленных)
  - Частота (ежедневно, еженедельно, ежемесячно, ежегодно)
  - Дата начала (обязательное)
  - Дата окончания (опциональное)
  - Примечание (опциональное)

#### UpcomingTransactionItem

- Компонент для отображения предстоящей транзакции
- Полупрозрачный стиль (opacity: 0.6)
- Показывает:
  - Метку "Upcoming"
  - Количество дней до платежа
  - Название транзакции
  - Запланированную дату
  - Сумму

#### ConfirmStep (обновлен)

- Добавлен селектор типа расписания (Standard/Scheduled)
- Только для транзакций типа `expense`
- При выборе "Scheduled" открывается модальное окно настройки

#### TransactionsList (обновлен)

- Отображает предстоящие транзакции в начале списка
- Раздел "Upcoming" с предстоящими транзакциями
- Раздел "Recent Transactions" с обычными транзакциями

### Логика расчета дат

#### calculateNextDueDate

```typescript
const calculateNextDueDate = (
  currentDate: string, // Текущая дата платежа
  frequency: RecurringFrequency,
  startDate: string // Дата начала (для месячных/годовых)
): string
```

- **Daily**: добавляет 1 день
- **Weekly**: добавляет 7 дней
- **Monthly**: добавляет 1 месяц, учитывая количество дней в месяце (если начальная дата 31-е, а следующий месяц имеет меньше дней, используется последний день месяца)
- **Yearly**: добавляет 1 год

#### isWithin3Days

Проверяет, находится ли дата в пределах 3 дней от текущей даты (включительно).

#### daysUntil

Вычисляет количество дней до указанной даты.

### Автоматическая обработка

1. При запуске приложения `RecurringTransactionsProvider` загружает данные из `AsyncStorage`
2. После загрузки вызывается `processRecurringTransactions()`
3. Проверяются все активные повторяющиеся транзакции:
   - Если `nextDueDate <= now`, создается обычная транзакция
   - Рассчитывается следующая дата платежа
   - Если достигнута `endDate`, транзакция помечается как `completed`
4. Обработка происходит один раз в день (отслеживается через `lastProcessedDateRef`)

### Хранение данных

- Ключ: `recurringTransactions`
- Формат: `RecurringTransaction[]`
- Валидация: `validateRecurringTransactions` проверяет структуру данных
- Миграция: не требуется (новая функция)

## Пользовательский сценарий

### Создание повторяющейся транзакции

1. Пользователь нажимает кнопку "+" для добавления транзакции
2. Выбирает тип "Expense"
3. Вводит сумму
4. Выбирает категорию
5. На этапе подтверждения выбирает "Scheduled" вместо "Standard"
6. Открывается модальное окно настройки:
   - Вводит название (например, "Netflix Subscription")
   - Выбирает тип "Subscription"
   - Выбирает частоту "Monthly"
   - Указывает дату начала (например, 1-е число следующего месяца)
   - Опционально указывает дату окончания
7. Нажимает "Save"
8. Повторяющаяся транзакция создана

### Отображение предстоящих транзакций

1. За 3 дня до запланированного платежа в списке транзакций появляется полупрозрачная карточка
2. Показывается:
   - Метка "Upcoming"
   - "3 days until" (или "Today", "Tomorrow")
   - Название транзакции
   - "Scheduled for: [дата]"
   - Сумма

### Автоматическое создание транзакции

1. Пользователь открывает приложение
2. Система проверяет активные повторяющиеся транзакции
3. Если дата платежа наступила, создается обычная транзакция
4. Транзакция появляется в списке с обычным стилем (не полупрозрачная)
5. Рассчитывается следующая дата платежа

## Локализация

Все строки локализованы на английский и украинский языки:

- `recurringTransactions.setupRecurring` — "Setup Recurring Transaction" / "Налаштування повторюваної транзакції"
- `recurringTransactions.upcoming` — "Upcoming" / "Майбутні"
- `recurringTransactions.scheduledFor` — "Scheduled for" / "Заплановано на"
- `recurringTransactions.daysUntil` — "{{days}} days until" / "{{days}} днів до"
- `recurringTransactions.today` — "Today" / "Сьогодні"
- `recurringTransactions.tomorrow` — "Tomorrow" / "Завтра"
- И другие...

## Ограничения

1. **Только для расходов**: В текущей версии повторяющиеся транзакции доступны только для типа `expense`
2. **Обработка раз в день**: Автоматическое создание транзакций происходит один раз в день при запуске приложения
3. **3 дня до платежа**: Предстоящие транзакции отображаются только за 3 дня до платежа
4. **Нет уведомлений**: В текущей версии нет push-уведомлений о предстоящих платежах (планируется в будущем)

## Будущие улучшения

1. **Поддержка всех типов транзакций**: Расширить на `income`, `saved`, `credit`
2. **Push-уведомления**: Уведомления за 3 дня, 1 день и в день платежа
3. **Экран управления**: Отдельный экран для просмотра и управления всеми повторяющимися транзакциями
4. **Редактирование**: Возможность редактировать активные повторяющиеся транзакции
5. **Статистика**: Показ статистики по повторяющимся транзакциям (сколько запланировано, сколько выполнено)
6. **Кастомные частоты**: Возможность задавать произвольные интервалы (например, каждые 2 недели)

## Тестирование

### Ручное тестирование

1. **Создание повторяющейся транзакции:**
   - Создать транзакцию расхода
   - Выбрать "Scheduled"
   - Заполнить форму
   - Проверить, что транзакция создана

2. **Отображение предстоящих транзакций:**
   - Создать повторяющуюся транзакцию с датой начала через 2 дня
   - Проверить, что она появляется в списке как предстоящая
   - Проверить корректность отображения дней до платежа

3. **Автоматическое создание транзакций:**
   - Создать повторяющуюся транзакцию с датой начала сегодня
   - Перезапустить приложение
   - Проверить, что создана обычная транзакция
   - Проверить, что следующая дата платежа рассчитана корректно

### Edge Cases

1. **Месяц с разным количеством дней:**
   - Создать месячную транзакцию с датой 31-го числа
   - Проверить, что в феврале используется 28/29-е число

2. **Дата окончания:**
   - Создать транзакцию с датой окончания
   - Дождаться этой даты
   - Проверить, что транзакция помечена как `completed`

3. **Приостановка/возобновление:**
   - Приостановить активную транзакцию
   - Проверить, что она не обрабатывается
   - Возобновить
   - Проверить, что обработка возобновлена

## Связанные файлы

- `src/types/index.ts` — типы данных
- `src/services/storage.ts` — функции хранения
- `src/state/RecurringTransactionsProvider.tsx` — провайдер состояния
- `src/components/AddTransaction/RecurringTransactionModal.tsx` — модальное окно настройки
- `src/components/AddTransaction/ConfirmStep.tsx` — шаг подтверждения (обновлен)
- `src/components/AddTransaction/AddTransactionModal.tsx` — основной модал (обновлен)
- `src/components/TransactionsList.tsx` — список транзакций (обновлен)
- `src/components/UpcomingTransactionItem.tsx` — компонент предстоящей транзакции
- `src/i18n/locales/en.json` — английская локализация
- `src/i18n/locales/uk.json` — украинская локализация

---

**Поддерживается командой разработки ExGo**

