# Функция "Цели" (Goals)

Документ описывает принцип работы функции финансовых целей в приложении ExGo, которая позволяет пользователям устанавливать цели накопления (например, "купить автомобиль", "накопить на первый взнос по ипотеке") и отслеживать прогресс их достижения.

## Цель и ценность

- Пользователь может устанавливать финансовые цели с целевой суммой накопления
- При добавлении транзакции типа "saved" (накопление) пользователь может указать, на какую цель откладываются средства
- Прогресс по каждой цели автоматически обновляется на основе связанных транзакций
- При достижении 100% цели автоматически помечается как выполненная с уведомлением и анимацией конфетти
- Пользователь видит прогресс по всем целям в отдельном разделе "Goals"

## UX и пользовательский поток

### Создание цели

1. **Точка входа:**
   - Из главного экрана: кнопка "+" → выбор "Goals" → переход на экран "Goals"
   - Из настроек: кнопка "Goals" → переход на экран "Goals"
   - На экране "Goals": кнопка "+ Create Goal" (если есть активные цели) или кнопка в EmptyState

2. **Модальное окно создания цели:**
   - **Название цели** (обязательное поле): текстовое поле для ввода названия цели
   - **Целевая сумма** (обязательное поле): числовое поле для ввода суммы накопления (> 0)
   - **Эмодзи** (опционально): выбор эмодзи из предустановленного списка для визуального обозначения цели
   - **Заметка** (опционально): текстовое поле для дополнительных заметок о цели
   - Кнопки: "Cancel" (отмена) и "Save" (сохранить)

3. **Валидация:**
   - Название не должно быть пустым
   - Целевая сумма должна быть положительным числом
   - Валюта наследуется из настроек пользователя

### Добавление транзакции типа "saved" с привязкой к цели

1. **Точка входа:**
   - Кнопка "+" на главном экране → выбор типа транзакции "Saved"

2. **Процесс добавления:**
   - **Шаг 1: Выбор типа** → выбор "Saved"
   - **Шаг 2: Ввод суммы** → ввод суммы накопления
   - **Шаг 3: Выбор цели** → выбор цели из списка активных целей или "No Goal (General Savings)"
     - Если целей нет, отображается кнопка "Create Goal" для создания новой цели
     - При создании новой цели в этом шаге она автоматически выбирается
   - **Шаг 4: Подтверждение** → просмотр деталей транзакции (сумма, категория, цель) и подтверждение

3. **Автоматическое обновление:**
   - После сохранения транзакции автоматически пересчитывается `currentAmount` для выбранной цели
   - Обновляется прогресс-бар в карточке цели
   - Если `currentAmount >= targetAmount`, цель автоматически помечается как выполненная

### Экран "Goals"

1. **Структура экрана:**
   - **Секция "Active Goals"** (Активные цели):
     - Список карточек активных целей с прогресс-барами
     - Если активных целей нет, отображается EmptyState с кнопкой "Create Goal"
   - **Секция "Completed Goals"** (Выполненные цели):
     - Список выполненных целей (если есть)
     - Выполненные цели отображаются с зеленой рамкой

2. **Карточка цели содержит:**
   - Эмодзи (если указан) и название цели
   - Заметку (если указана)
   - Прогресс-бар с процентами выполнения
   - Статистику:
     - **Saved** (Накоплено): текущая сумма накопления
     - **Target** (Цель): целевая сумма
     - **Remaining** (Осталось): разница между целью и накопленной суммой
   - Процент выполнения: "X.X% complete"
   - Кнопки управления (только для активных целей):
     - **Mark Complete** (Пометить как выполненную): вручную помечает цель как выполненную
     - **Edit** (Редактировать): открывает модальное окно редактирования
     - **Delete** (Удалить): удаляет цель с подтверждением

3. **Визуальные индикаторы:**
   - Активные цели: стандартная карточка
   - Выполненные цели: карточка с зеленой рамкой (borderWidth: 3, borderColor: positive)

### Уведомление о выполнении цели

1. **Автоматическое выполнение:**
   - Когда `currentAmount >= targetAmount`, цель автоматически помечается как выполненная
   - Показывается уведомление (Alert) с поздравлением от команды ExGo
   - Запускается глобальная анимация конфетти на весь экран

2. **Ручное выполнение:**
   - Пользователь может вручную пометить цель как выполненную через кнопку "Mark Complete"
   - При этом также показывается уведомление и анимация конфетти

### Отображение цели в транзакциях

- В разделе "Recent Transactions" на главном экране транзакции типа "saved" отображаются с указанием связанной цели
- Формат: название цели с эмодзи (если указан) или "No Goal (General Savings)"

## Данные и модели

### Тип `Goal`

```typescript
export type GoalStatus = 'active' | 'completed' | 'archived';

export interface Goal {
  id: string;                    // Уникальный идентификатор цели
  name: string;                   // Название цели
  targetAmount: number;           // Целевая сумма накопления
  currentAmount: number;          // Текущая сумма накопления (сумма связанных транзакций)
  currency: string;              // Валюта (наследуется из settings)
  emoji?: string;                // Опциональное эмодзи для визуального обозначения
  status: GoalStatus;            // Статус цели: 'active' | 'completed' | 'archived'
  createdAt: string;             // ISO строка даты создания
  updatedAt: string;             // ISO строка даты последнего обновления
  completedAt?: string;          // ISO строка даты выполнения (если выполнена)
  note?: string;                 // Опциональная заметка
}
```

### Обновление типа `Transaction`

Транзакции типа `saved` теперь могут содержать поле `goalId`:

```typescript
export interface Transaction {
  // ... существующие поля
  type: TransactionType;         // 'income' | 'expense' | 'saved' | 'credit'
  goalId?: string;               // ID связанной цели (только для type === 'saved')
  // ... остальные поля
}
```

### Производные поля

- **Прогресс выполнения:** `(currentAmount / targetAmount) * 100` (в процентах, максимум 100%)
- **Осталось накопить:** `Math.max(targetAmount - currentAmount, 0)`
- **Статус выполнения:** автоматически определяется как `completed`, если `currentAmount >= targetAmount`

## Хранилище и стейт

### AsyncStorage

- **Ключ:** `goals` (строка)
- **Формат:** JSON массив объектов `Goal[]`
- **Валидация:** функция `validateGoals()` проверяет структуру данных перед сохранением/загрузкой

### Стейт-слой: `GoalsProvider`

`GoalsProvider` предоставляет контекст для управления целями и интегрируется с `TransactionsProvider` для автоматического пересчета прогресса.

#### Основные методы:

- `createGoal(input)` → создает новую цель и сохраняет в AsyncStorage
- `updateGoal(id, input)` → обновляет существующую цель
- `deleteGoal(id)` → удаляет цель
- `getActiveGoals()` → возвращает список активных целей
- `getGoalById(id)` → возвращает цель по ID
- `recalculateGoalProgress(goalId)` → пересчитывает прогресс для конкретной цели
- `recalculateAllGoalsProgress()` → пересчитывает прогресс для всех целей

#### Интеграция с транзакциями:

- `GoalsProvider` подписывается на изменения `transactionsByMonth` из `TransactionsProvider`
- Используется `useMemo` для создания стабильного хеша сохраненных транзакций (`savedTransactionsHash`)
- При изменении сохраненных транзакций автоматически пересчитывается прогресс всех целей
- Используется функциональное обновление состояния (`setGoals((currentGoals) => ...)`) для гарантии актуальных данных

#### Логика пересчета:

1. **Функция `calculateGoalCurrentAmount(goalId, transactionsByMonth)`:**
   - Проходит по всем транзакциям во всех месяцах
   - Суммирует суммы транзакций типа `saved` с `goalId === goalId`
   - Возвращает общую сумму накопления для цели

2. **Функция `updateGoalStatus(goal)`:**
   - Проверяет, достигнута ли цель: `currentAmount >= targetAmount`
   - Если достигнута и статус `active`, меняет статус на `completed` и устанавливает `completedAt`
   - Если не достигнута и статус `completed`, меняет статус обратно на `active` и удаляет `completedAt`

3. **Автоматический пересчет:**
   - При изменении `transactionsByMonth` создается новый хеш сохраненных транзакций
   - Если хеш изменился, вызывается `recalculateAllGoalsProgress()`
   - Пересчитывается `currentAmount` для всех целей
   - Обновляется статус целей на основе нового `currentAmount`
   - Если цель только что стала выполненной, вызывается callback `onGoalCompleted`

## Бизнес-правила

1. **Создание цели:**
   - Название обязательно и не должно быть пустым
   - Целевая сумма должна быть положительным числом (> 0)
   - Валюта наследуется из настроек пользователя
   - При создании `currentAmount` инициализируется как 0
   - Статус по умолчанию: `active`

2. **Обновление цели:**
   - Можно изменить название, целевую сумму, эмодзи, заметку
   - Можно вручную изменить статус (например, пометить как выполненную)
   - При изменении целевой суммы пересчитывается прогресс
   - `currentAmount` всегда пересчитывается из транзакций и не может быть изменен вручную

3. **Удаление цели:**
   - При удалении цели связанные транзакции сохраняются, но теряют связь (`goalId` остается в транзакции, но цель больше не существует)
   - Удаление требует подтверждения

4. **Автоматическое выполнение:**
   - Цель автоматически помечается как выполненная, когда `currentAmount >= targetAmount`
   - При выполнении показывается уведомление и анимация конфетти
   - Выполненная цель отображается с зеленой рамкой

5. **Транзакции типа "saved":**
   - При добавлении транзакции типа "saved" пользователь может выбрать цель или оставить "No Goal (General Savings)"
   - Если цель не выбрана, транзакция сохраняется без `goalId`
   - Транзакции без `goalId` не учитываются в прогрессе целей

6. **Пересчет прогресса:**
   - Прогресс пересчитывается автоматически при изменении транзакций
   - Пересчет происходит для всех целей одновременно
   - Используется функциональное обновление состояния для гарантии актуальных данных

## Архитектура компонентов

### Основные компоненты

1. **`GoalsProvider`** (`src/state/GoalsProvider.tsx`):
   - Контекст-провайдер для управления состоянием целей
   - Интегрируется с `TransactionsProvider` для отслеживания изменений транзакций
   - Предоставляет методы для CRUD операций с целями
   - Автоматически пересчитывает прогресс при изменении транзакций

2. **`GoalsScreen`** (`src/screens/GoalsScreen.tsx`):
   - Главный экран для отображения списка целей
   - Разделяет цели на активные и выполненные
   - Использует `GoalCard` для отображения каждой цели
   - Интегрируется с `AddGoalModal` для создания/редактирования целей

3. **`AddGoalModal`** (`src/components/AddGoalModal.tsx`):
   - Модальное окно для создания и редактирования целей
   - Форма с валидацией полей
   - Выбор эмодзи из предустановленного списка
   - Поддержка режима создания и редактирования

4. **`GoalSelectionStep`** (`src/components/AddTransaction/GoalSelectionStep.tsx`):
   - Компонент для выбора цели при добавлении транзакции типа "saved"
   - Отображает список активных целей с прогресс-барами
   - Позволяет создать новую цель или выбрать "No Goal"
   - Интегрируется с `AddGoalModal` для создания новых целей

5. **`ConfettiAnimation`** (`src/components/ConfettiAnimation.tsx`):
   - Компонент для отображения анимации конфетти при выполнении цели
   - Использует стандартный `Animated` API из React Native
   - Отображается поверх всего экрана (zIndex: 9999)

6. **`ConfettiProvider`** (`src/state/ConfettiProvider.tsx`):
   - Контекст-провайдер для управления глобальной анимацией конфетти
   - Предоставляет метод `showConfetti()` для запуска анимации
   - Рендерит `ConfettiAnimation` как дочерний компонент

### Интеграция с другими провайдерами

1. **`AppProvider`** (`src/state/AppProvider.tsx`):
   - Обертка для всех провайдеров приложения
   - `GoalsProvider` обернут в `GoalsProviderWithCallbacks`, который обрабатывает событие выполнения цели
   - `ConfettiProvider` обернут вокруг `GoalsProvider` для глобального доступа к анимации

2. **`GoalsProviderWithCallbacks`:**
   - Промежуточный компонент, который использует `useConfetti()` и `useTranslation()`
   - Обрабатывает callback `onGoalCompleted` от `GoalsProvider`
   - Показывает уведомление и запускает анимацию конфетти при выполнении цели

## Потоки данных

### Создание цели

```
User → GoalsScreen → AddGoalModal → GoalsProvider.createGoal() 
  → saveGoals() → AsyncStorage → setGoals() → UI обновление
```

### Добавление транзакции с целью

```
User → AddTransactionModal → GoalSelectionStep → AddTransactionModal.handleConfirm()
  → TransactionsProvider.addTransaction() → setTransactionsByMonth()
  → GoalsProvider.useEffect (отслеживание savedTransactionsHash)
  → recalculateAllGoalsProgress() → calculateGoalCurrentAmount()
  → updateGoalStatus() → setGoals() → UI обновление
  → (если цель выполнена) → onGoalCompleted() → ConfettiProvider.showConfetti()
  → Alert.alert() → анимация конфетти
```

### Автоматический пересчет прогресса

```
TransactionsProvider.addTransaction() → setTransactionsByMonth()
  → GoalsProvider.useMemo (savedTransactionsHash) → новый хеш
  → GoalsProvider.useEffect (изменение хеша) → recalculateAllGoalsProgress()
  → setGoals((currentGoals) => ...) → функциональное обновление
  → calculateGoalCurrentAmount() для каждой цели
  → updateGoalStatus() для каждой цели
  → setGoals(recalculated) → UI обновление
```

## Технические детали

### Отслеживание изменений транзакций

Для эффективного отслеживания изменений сохраненных транзакций используется подход с хешированием:

1. **`useMemo` для создания стабильного хеша:**
   ```typescript
   const savedTransactionsHash = useMemo(() => {
     const savedTxs = Object.keys(transactionsByMonth)
       .sort()
       .flatMap(month => 
         (transactionsByMonth[month] || [])
           .filter(tx => tx.type === 'saved' && tx.goalId)
           .map(tx => ({ month, id: tx.id, goalId: tx.goalId, amount: tx.amount }))
       )
       .sort((a, b) => a.id.localeCompare(b.id));
     
     return JSON.stringify(savedTxs);
   }, [transactionsByMonth]);
   ```

2. **`useRef` для отслеживания предыдущего хеша:**
   ```typescript
   const prevHashRef = useRef<string>('');
   ```

3. **`useEffect` для реакции на изменения:**
   - Зависит от `savedTransactionsHash`
   - Сравнивает текущий хеш с предыдущим
   - Если хеш изменился, запускает пересчет

### Функциональное обновление состояния

Для гарантии использования актуального состояния целей при пересчете используется функциональное обновление:

```typescript
const recalculateAllGoalsProgress = useCallback(async (): Promise<Goal[]> => {
  return new Promise<Goal[]>((resolve) => {
    setGoals((currentGoals) => {
      // Используем currentGoals вместо goals из замыкания
      const recalculated = currentGoals.map((goal) => {
        const currentAmount = calculateGoalCurrentAmount(goal.id, transactionsByMonth);
        const updatedGoal = { ...goal, currentAmount };
        return updateGoalStatus(updatedGoal);
      });
      
      // Сохранение и разрешение промиса
      saveGoals(recalculated).then(...);
      resolve(newlyCompleted);
      
      return recalculated;
    });
  });
}, [transactionsByMonth]);
```

### Глобальная анимация конфетти

Анимация конфетти реализована через глобальный провайдер для обеспечения доступности из любого экрана:

1. **`ConfettiProvider`** оборачивает все приложение
2. **`ConfettiAnimation`** рендерится как дочерний компонент провайдера
3. Метод `showConfetti()` устанавливает `visible={true}`
4. После завершения анимации `onComplete` устанавливает `visible={false}`

## Локализация

Все строки интерфейса локализованы через `i18next`:

- **Ключи в `en.json` и `uk.json`:**
  - `goals.*` - все строки, связанные с целями
  - `addTransaction.goal` - выбор цели при добавлении транзакции
  - `goals.completedTitle` и `goals.completedMessage` - уведомление о выполнении цели

## Ограничения и известные проблемы

1. **Валюта:**
   - Валюта цели наследуется из настроек при создании
   - При смене валюты в настройках валюта существующих целей не обновляется автоматически
   - Рекомендация: пересоздать цели при смене валюты

2. **Удаление цели:**
   - При удалении цели связанные транзакции сохраняются с `goalId`
   - Эти транзакции больше не учитываются в прогрессе (так как цель не существует)
   - Рекомендация: перед удалением цели рассмотреть возможность архивации

3. **Производительность:**
   - Пересчет прогресса происходит для всех целей при каждом изменении транзакций
   - Для большого количества целей (>100) может потребоваться оптимизация
   - Текущая реализация использует `useMemo` и хеширование для минимизации пересчетов

## Будущие улучшения

1. **Архивация целей:**
   - Добавить возможность архивации целей вместо удаления
   - Архивированные цели не отображаются в основном списке, но сохраняются в истории

2. **Категории целей:**
   - Добавить возможность группировки целей по категориям
   - Примеры категорий: "Автомобиль", "Недвижимость", "Путешествия"

3. **Временные рамки:**
   - Добавить поле "дедлайн" для цели
   - Отображать прогресс с учетом временных рамок
   - Предупреждения при приближении дедлайна

4. **Статистика:**
   - Добавить график прогресса по цели во времени
   - Показывать среднюю скорость накопления
   - Прогноз достижения цели на основе текущего темпа

5. **Множественные валюты:**
   - Поддержка целей в разных валютах
   - Конвертация при отображении

## Версия документа

- **Дата создания:** 2025-01-27
- **Последнее обновление:** 2025-01-27
- **Версия функции:** 1.0.0

