# Функция "Календарь" (Calendar)

Документ описывает принцип работы функции календаря в приложении ExGo, которая позволяет пользователям просматривать и выбирать любой месяц для отображения данных на главном экране.

## Цель и ценность

- Пользователь может быстро перейти к любому месяцу через удобный календарный интерфейс
- Календарь отображает все 12 месяцев выбранного года в виде сетки
- При выборе месяца автоматически открывается главный экран с данными выбранного месяца
- Иконка календаря доступна прямо на главном экране, возле доната
- Поддержка навигации между годами (текущий год ± 2 года)

## UX и пользовательский поток

### Открытие календаря

1. **Точка входа:**
   - На главном экране (HomeScreen): иконка календаря в правом верхнем углу секции с донатом
   - Иконка расположена напротив надписи с текущим месяцем

2. **Визуальное представление:**
   - Иконка календаря (24x24px) с цветом `textSecondary`
   - При нажатии открывается модальный экран календаря

### Экран календаря (CalendarScreen)

1. **Структура экрана:**
   - **Заголовок:** "Select Month" / "Виберіть місяць" (локализовано)
   - **Селектор года:** горизонтальный скролл с годами (текущий год ± 2 года, всего 5 лет)
   - **Сетка месяцев:** 12 месяцев выбранного года в виде карточек (3 колонки)

2. **Селектор года:**
   - Горизонтальный скролл с кнопками годов
   - Выбранный год подсвечивается цветом акцента
   - При выборе года обновляется сетка месяцев

3. **Сетка месяцев:**
   - Каждый месяц отображается в виде карточки (`Card` компонент)
   - Название месяца локализовано (например, "January 2025" / "Січень 2025")
   - Текущий месяц помечен бейджем "Current" / "Поточний"
   - Выбранный месяц (если передан `initialMonth`) помечен бейджем "Selected" / "Вибрано"
   - Текущий и выбранный месяцы имеют цветную рамку (цвет акцента)

4. **Выбор месяца:**
   - При нажатии на карточку месяца происходит навигация на главный экран
   - Передается параметр `month` в формате `YYYY-MM` (например, "2025-12")
   - Главный экран автоматически переключается на выбранный месяц

### Интеграция с главным экраном

1. **Обработка параметра месяца:**
   - `HomeScreen` принимает параметр `month` через route params
   - Используется `useRef` для отслеживания последнего обработанного месяца (предотвращение бесконечных циклов)
   - `useEffect` срабатывает только при изменении `route.params?.month`
   - Вызывается `setCurrentMonth` из `TransactionsProvider` для переключения месяца

2. **Отображение данных:**
   - После выбора месяца все данные главного экрана обновляются:
     - Транзакции для выбранного месяца
     - Баланс и статистика
     - График доната
     - Список последних транзакций

## Технические детали

### Компоненты

#### CalendarIcon
- **Расположение:** `src/components/icons/CalendarIcon.tsx`
- **Тип:** SVG иконка
- **Размер:** 24x24px (по умолчанию)
- **Цвет:** Наследуется из темы или передается через props
- **Использование:** Отображается на `HomeScreen` в секции с донатом

#### CalendarScreen
- **Расположение:** `src/screens/CalendarScreen.tsx`
- **Тип:** React Native Screen Component
- **Навигация:** Модальный экран (`presentation: 'modal'`)
- **Параметры route:**
  - `initialMonth?: string` - начальный месяц для отображения (формат `YYYY-MM`)

### Навигация

#### RootStackParamList
```typescript
export type RootStackParamList = {
  // ...
  Home: { month?: string } | undefined;
  Calendar: { initialMonth?: string } | undefined;
};
```

#### Навигация из календаря
```typescript
navigation.navigate('Home', { month: monthKey });
```

#### Навигация к календарю
```typescript
navigation.navigate('Calendar', { initialMonth: currentMonth });
```

### Утилиты для работы с месяцами

#### formatMonthName
- **Расположение:** `src/utils/month.ts`
- **Функция:** Форматирует ключ месяца в читаемое название
- **Пример:** `"2025-12"` → `"December 2025"` / `"Грудень 2025"`
- **Локализация:** Использует `getCurrentLanguage()` для определения языка

#### parseMonthKey
- **Функция:** Парсит ключ месяца в объект `Date`
- **Пример:** `"2025-12"` → `new Date(2025, 11, 1)`

#### isCurrentMonth
- **Функция:** Проверяет, является ли месяц текущим
- **Использование:** Для подсветки текущего месяца в календаре

### Предотвращение бесконечных циклов

#### Проблема
Изначально `useEffect` в `HomeScreen` зависел от `currentMonth` и `setCurrentMonth`, что вызывало бесконечный цикл:
1. `setCurrentMonth` вызывается → изменяется `currentMonth`
2. Изменение `currentMonth` триггерит `useEffect`
3. `useEffect` снова вызывает `setCurrentMonth` → цикл

#### Решение
```typescript
// Track last processed month from route params to prevent infinite loops
const lastProcessedMonthRef = React.useRef<string | null>(null);

React.useEffect(() => {
  const routeMonth = route.params?.month;
  
  // Only process if:
  // 1. Route has a month parameter
  // 2. It's different from current month
  // 3. We haven't already processed this exact route param value
  if (routeMonth && routeMonth !== currentMonth && routeMonth !== lastProcessedMonthRef.current) {
    lastProcessedMonthRef.current = routeMonth;
    setCurrentMonth(routeMonth).catch((err) => {
      console.error('[HomeScreen] Error setting month from route params:', err);
    });
  }
}, [route.params?.month]); // Only depend on route.params?.month
```

**Ключевые моменты:**
- `useRef` отслеживает последний обработанный месяц
- `useEffect` зависит только от `route.params?.month`
- Проверка предотвращает повторную обработку одного и того же месяца

## Локализация

### Ключи локализации

#### Английский (en.json)
```json
{
  "calendar": {
    "title": "Select Month",
    "current": "Current",
    "selected": "Selected",
    "openCalendar": "Open calendar to select month"
  }
}
```

#### Украинский (uk.json)
```json
{
  "calendar": {
    "title": "Виберіть місяць",
    "current": "Поточний",
    "selected": "Вибрано",
    "openCalendar": "Відкрити календар для вибору місяця"
  }
}
```

### Локализация названий месяцев

Названия месяцев локализуются автоматически через `formatMonthName`, который использует:
- `getCurrentLanguage()` для определения языка
- `toLocaleDateString` с соответствующим locale (`en-US` или `uk-UA`)

## Ограничения и известные проблемы

1. **Диапазон годов:**
   - Доступны только 5 лет (текущий год ± 2 года)
   - Для расширения диапазона нужно модифицировать `years` в `CalendarScreen`

2. **Производительность:**
   - При большом количестве транзакций переключение месяца может занимать время
   - Оптимизировано через `useMemo` для генерации месяцев

3. **Навигация:**
   - При выборе месяца календарь закрывается, но не возвращается на предыдущий экран
   - Это ожидаемое поведение (модальный экран)

## Будущие улучшения

1. **Расширенный диапазон годов:**
   - Добавить возможность выбора любого года (не только ± 2 года)
   - Добавить поиск по году

2. **Визуальные улучшения:**
   - Показывать количество транзакций в каждом месяце
   - Подсветка месяцев с данными
   - Мини-график для каждого месяца

3. **Быстрая навигация:**
   - Кнопки "Сегодня", "Предыдущий месяц", "Следующий месяц"
   - Жесты для переключения года

4. **Интеграция с другими экранами:**
   - Возможность открыть календарь из других экранов
   - Сохранение последнего выбранного месяца

## Файлы

### Созданные файлы
- `src/components/icons/CalendarIcon.tsx` - Иконка календаря
- `src/screens/CalendarScreen.tsx` - Экран календаря

### Измененные файлы
- `src/components/icons/index.ts` - Экспорт CalendarIcon
- `src/navigation/RootNavigator.tsx` - Добавлен экран Calendar, обновлен тип Home
- `src/screens/HomeScreen.tsx` - Добавлена иконка календаря, обработка параметра месяца
- `src/i18n/locales/en.json` - Добавлены ключи локализации
- `src/i18n/locales/uk.json` - Добавлены ключи локализации

## Версия

**Версия:** 1.0.0  
**Дата:** 2025-01-27  
**Статус:** ✅ Реализовано

---

**Поддерживается командой разработки ExGo**

